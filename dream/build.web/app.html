<!doctype HTML>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <title>Dream</title>
    <link rel="apple-touch-icon-precomposed" sizes="57x57" href="favicon/apple-touch-icon-57x57.png" />
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="favicon/apple-touch-icon-114x114.png" />
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="favicon/apple-touch-icon-72x72.png" />
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="favicon/apple-touch-icon-144x144.png" />
    <link rel="apple-touch-icon-precomposed" sizes="60x60" href="favicon/apple-touch-icon-60x60.png" />
    <link rel="apple-touch-icon-precomposed" sizes="120x120" href="favicon/apple-touch-icon-120x120.png" />
    <link rel="apple-touch-icon-precomposed" sizes="76x76" href="favicon/apple-touch-icon-76x76.png" />
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="favicon/apple-touch-icon-152x152.png" />
    <link rel="icon" type="image/png" href="favicon/favicon-196x196.png" sizes="196x196" />
    <link rel="icon" type="image/png" href="favicon/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/png" href="favicon/favicon-32x32.png" sizes="32x32" />
    <link rel="icon" type="image/png" href="favicon/favicon-16x16.png" sizes="16x16" />
    <link rel="icon" type="image/png" href="favicon/favicon-128.png" sizes="128x128" />
    <meta name="application-name" content="&nbsp;"/>
    <meta name="msapplication-TileColor" content="#FFFFFF" />
    <meta name="msapplication-TileImage" content="favicon/mstile-144x144.png" />
    <meta name="msapplication-square70x70logo" content="favicon/mstile-70x70.png" />
    <meta name="msapplication-square150x150logo" content="favicon/mstile-150x150.png" />
    <meta name="msapplication-wide310x150logo" content="favicon/mstile-310x150.png" />
    <meta name="msapplication-square310x310logo" content="favicon/mstile-310x310.png" />
    <style>
        html {
            width: 100%;
            height: 100%;
            background: black;
        }
        body {
            display: -webkit-flex;
            display: flex;
            -webkit-flex-direction: column;
            flex-direction: column;
            width: 100%;
            height: 100%;
            font-family: sans-serif;
            margin: 0;
            padding: 0;
            overflow: hidden;
            background: black;
        }
        #canvas {
            -webkit-flex: 1;
            flex: 1;
            width: 100%;
            min-height: 10%;
        }
        #status {
            background-color: hsl(60,20%,90%);
            text-align: center;
            height: 0;
        }
        #output {
            position: absolute;

            /*background-color: hsla(240,10%,10%,0.0);*/
            /*color: black;*/
            /*border: none;*/
            /*padding: 0 1em;*/
            /*position: absolute;*/
            /*right: 0; width: 50%;*/
            /*bottom: 0;*/
        }
    </style>
</head>
<body>

<div>
    <p style="color: white;" id="output">Test</p>
</div>

<canvas ondrop="dropHandler(event);"
        ondragover="dragOverHandler(event);"
        id="canvas"
        oncontextmenu="event.preventDefault()"></canvas>

<script type='text/javascript'>
    const outputElement = document.getElementById('output');

    var Module = {
        print: (function(text) {
            return function(text) {
                if (arguments.length > 1) text = Array.prototype.slice.call(arguments).join(' ');
                console.log(text);
            };
        })(),
        printErr: function(text) {
            console.error(text);
        },
        getPreloadedPackage: function(remotePackageName, remotePackageSize) {
            console.log("remote package name", remotePackageName);
            console.log("remote package size", remotePackageSize);
            return Module['downloadedData'];
        },
        canvas: document.getElementById('canvas'),
        onRuntimeInitialized: function() {
            outputElement.remove();
            let disablePointerLock = Module.cwrap('disablePointerLock', null, []);
            document.addEventListener('pointerlockchange', lockChangeAlert, false);
            function lockChangeAlert() {
                if (!document.pointerLockElement) {
                    disablePointerLock();
                }
            }
        },
        totalDependencies: 0,
        monitorRunDependencies: function(left) {
            this.totalDependencies = Math.max(this.totalDependencies, left);
            const frac = (this.totalDependencies - left) / this.totalDependencies;
            const percent = Math.floor(frac * 100);
            if (percent === 99) {
                outputElement.innerText = `Loading Project`;
            } else {
                outputElement.innerText = `Initializing (${percent}%)`;
            }
        },
        locateFile: function(path, prefix) {
            // console.log(path, prefix);
            // return 'https://dream-web-demo.s3.amazonaws.com/dream/' + path;
            return prefix + path;
        }
    };

    function download(url, name) {
        outputElement.innerText = `Downloading ${name}`;

        return new Promise(function(resolve, reject) {
            let xhr = new XMLHttpRequest();
            xhr.open('GET', url, true);
            xhr.responseType = 'arraybuffer';
            xhr.onload = function() {
                resolve(xhr.response);
                outputElement.innerText = "Downloaded " + url;
            };
            xhr.onprogress = function(evt) {
                if (evt.lengthComputable) {
                    const percentComplete = (evt.loaded / evt.total) * 100;
                    outputElement.innerText = `Downloading ${name} (${Math.floor(percentComplete)}%)`;
                }
            };
            xhr.onerror = function(e) {
                reject(e);
                outputElement.innerText = "Failed to download " + url;
            };
            xhr.send(null);
        });
    }

    function addScriptToDom(scriptCode) {
        outputElement.innerText = "Loading Engine JS";

        return new Promise(function(resolve, reject) {
            let script = document.createElement('script');
            let blob = new Blob([scriptCode], { type: 'application/javascript' });
            let objectUrl = URL.createObjectURL(blob);
            script.src = objectUrl;
            script.onload = function() {
                outputElement.innerText = "Loaded Engine JS";
                script.onload = script.onerror = null; // Remove these onload and onerror handlers, because these capture the inputs to the Promise and the input function, which would leak a lot of memory!
                URL.revokeObjectURL(objectUrl); // Free up the blob. Note that for debugging purposes, this can be useful to comment out to be able to read the sources in debugger.
                resolve();
            }
            script.onerror = function(e) {
                outputElement.innerText = "Failed to load engine JS";
                script.onload = script.onerror = null; // Remove these onload and onerror handlers, because these capture the inputs to the Promise and the input function, which would leak a lot of memory!
                URL.revokeObjectURL(objectUrl);
                console.error('script failed to add to dom: ' + e);
                reject(e.message || "(out of memory?)");
                alert("Error loading script. Dom might have run out of memory.");
            }
            document.body.appendChild(script);
        });
    }

    var dataDownload = download('dream.data', 'Assets').then(function(data) {
        Module['downloadedData'] = data;
        var jsDownload = download('dream.js', 'Dream Engine JS').then(function(data) {
            Module['mainScriptUrlOrBlob'] = new Blob([data]);
            addScriptToDom(data);
        });
    });

    function dropHandler(event) {
        event.preventDefault();

        const traverseFileTree = (item, path) => {
            path = path || "";
            if (item.isFile) {
                // Get file
                item.file(function(file) {
                    console.log("TODO: import file ", path + file.name);
                });
            } else if (item.isDirectory) {
                // Get folder contents
                const dirReader = item.createReader();
                dirReader.readEntries(function(entries) {
                    for (let i = 0; i < entries.length; i++) {
                        traverseFileTree(entries[i], path + item.name + "/");
                    }
                });
            }
        }

        const items = event?.dataTransfer?.items;
        if (items) {
            for (let i = 0; i < items.length; i++) {
                const item = items[i].webkitGetAsEntry();
                if (item) {
                    traverseFileTree(item);
                }
            }
        } else {
            alert("Unable to import files in this browser.");
        }
    }

    function dragOverHandler(event) {
        event.preventDefault();
    }
</script>
</body>
</html>